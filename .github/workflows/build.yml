name: Build and Release
on:
  pull_request:
  push:
    branches:
      - master

jobs:
  build_for_linux:
    runs-on: ubuntu-latest
    name: Build for Linux
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build Docker builder image
        run: docker build --build-arg UID=$(id -u) --build-arg GID=$(id -g) -f .github/docker/linux/Dockerfile -t builder .
      - name: Build
        run: docker run --rm -e CI -v $(pwd):/app -w /app builder
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: jvips-libs-linux
          path: JVips-libs.tar.gz

  build_for_windows:
    runs-on: ubuntu-latest
    name: Build for Windows
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Build Docker builder image
        run: docker build --build-arg UID=$(id -u) --build-arg GID=$(id -g) -f .github/docker/windows/Dockerfile -t builder .
      - name: Build
        run: docker run --rm -e CI -v $(pwd):/app -w /app builder
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: jvips-libs-windows
          path: JVips-libs.tar.gz

  build_for_macos:
    runs-on: macos-latest
    name: Build for macOS
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Select Java
        uses: actions/setup-java@v1
        with:
          java-version: "1.8.0"
          java-package: jdk
          architecture: x64
      - name: Install vips
        run: ./setup-for-macos.sh
      - name: Build
        run: ./build.sh --with-macos --without-w64 --without-linux
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: jvips-libs-macos
          path: JVips-libs.tar.gz

  release:
    needs: [build_for_linux, build_for_macos, build_for_windows]
    if: github.ref == "refs/heads/master"
    runs-on: ubuntu-latest
    name: Merge macOS, Linux, Windows artifacts into a JAR and release it
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v2
        with:
          path: artifacts
      - name: Extract libraries
        run: for jar in artifacts/*/JVips-libs.tar.gz; do tar xvf $jar; done
      - name: Set version
        id: version
        run: |
          source lib/variables.sh
          VERSION="$VIPS_VERSION-$(git rev-parse --short HEAD)"
          mvn -B versions:set -DnewVersion=$VERSION
          echo "::set-output name=jar_version::$VERSION"
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: jvips
          path: JVips.jar
      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.jar_version }}
          release_name: ${{ steps.version.outputs.jar_version }}
          draft: false
          prerelease: false
      - name: Upload release asset
        id: upload-release-asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: JVips.jar
          asset_name: JVips.jar
          asset_content_type: application/java-archive
